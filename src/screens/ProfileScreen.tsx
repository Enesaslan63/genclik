import React, { useState } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, Modal, TextInput, ScrollView, Platform, Switch, KeyboardAvoidingView } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useNavigation } from '@react-navigation/native';
import { LinearGradient } from 'expo-linear-gradient';
import { ChevronRight, Bell, ShieldCheck, LogOut, User as UserIcon, X, Settings, HelpCircle, Info, Edit3, ArrowLeft, Moon } from 'lucide-react-native';
import { Colors } from '@/constants/Colors';
import { MOCK_USER } from '@/api/mockData';
import { useThemeMode } from '@/context/ThemeContext';
import type { StackNavigationProp } from '@react-navigation/stack';
import type { RootStackParamList } from '@/types/navigation';

type Nav = StackNavigationProp<RootStackParamList>;

const ProfileScreen = () => {
  const { mode, toggleTheme } = useThemeMode();
  const [modalVisible, setModalVisible] = useState(false);
  const [privacyModalVisible, setPrivacyModalVisible] = useState(false);
  const [accountSettingsVisible, setAccountSettingsVisible] = useState(false);
  const [userName, setUserName] = useState(MOCK_USER.name || '');
  const [userEmail, setUserEmail] = useState('');
  const [eventNotificationsEnabled, setEventNotificationsEnabled] = useState(true);
  const [discountNotificationsEnabled, setDiscountNotificationsEnabled] = useState(true);
  const [locationNotificationsEnabled, setLocationNotificationsEnabled] = useState(false);
  const [analyticsEnabled, setAnalyticsEnabled] = useState(true);
  const [personalizationEnabled, setPersonalizationEnabled] = useState(true);
  const navigation = useNavigation<Nav>();

  const userInitial = (userName?.charAt(0) ?? '').toUpperCase();
  const isDark = mode === 'dark';

  const handleLogout = () => {
    navigation.reset({
      index: 0,
      routes: [{ name: 'Welcome' }],
    });
  };

  const MenuItem = ({ label, icon, onPress, isLast, isDestructive }: { label: string, icon: React.ReactNode, onPress?: () => void, isLast?: boolean, isDestructive?: boolean }) => (
    <TouchableOpacity 
      style={[styles.menuItem, isLast && styles.menuItemLast, isDark && { borderBottomColor: '#334155' }]} 
      onPress={onPress}
      activeOpacity={0.7}
    >
      <View style={styles.menuItemLeft}>
        <View style={styles.menuIconContainer}>
          {icon}
        </View>
        <Text style={[styles.menuItemText, isDark && { color: '#f8fafc' }, isDestructive && { color: Colors.accent.rose }]}>
          {label}
        </Text>
      </View>
      <ChevronRight color={isDark ? '#64748b' : '#9ca3af'} size={20} />
    </TouchableOpacity>
  );

  return (
    <SafeAreaView style={[styles.root, isDark && { backgroundColor: '#0f172a' }]} edges={['top']}>
      <ScrollView 
        showsVerticalScrollIndicator={false} 
        contentContainerStyle={styles.scrollContent}
        style={styles.scrollView}
        bounces={true}
      >
          {/* Gradient Header */}
          <View style={styles.headerContainer}>
            <LinearGradient
              colors={['#8b5cf6', '#ec4899', '#3b82f6']}
              start={{ x: 0, y: 0 }}
              end={{ x: 1, y: 0 }}
              style={styles.gradientHeader}
            >
              <TouchableOpacity 
                style={styles.backButton}
                onPress={() => navigation.goBack()}
              >
                <ArrowLeft color="#fff" size={24} />
              </TouchableOpacity>
            </LinearGradient>
            
            {/* Avatar Section - Overlapping Header */}
            <View style={styles.avatarContainer}>
              <View style={styles.avatarWrapper}>
                <LinearGradient
                  colors={['#8b5cf6', '#ec4899', '#f59e0b', '#3b82f6']}
                  style={styles.avatarGradientBorder}
                >
                  <View style={[styles.avatarInner, isDark && { backgroundColor: '#1e293b' }]}>
                    <Text style={[styles.avatarText, isDark && { color: '#f8fafc' }]}>{userInitial}</Text>
                  </View>
                </LinearGradient>
              </View>
              <Text style={[styles.userName, isDark && { color: '#f8fafc' }]}>{userName}</Text>
              <Text style={[styles.userStatus, isDark && { color: '#94a3b8' }]}>{MOCK_USER.status}</Text>
            </View>
          </View>

          {/* Verification Card */}
          {!MOCK_USER.isVerified && (
            <TouchableOpacity 
              style={[styles.verificationCard, isDark && { backgroundColor: '#1e1b16', borderColor: '#3b341f' }]} 
              onPress={() => setModalVisible(true)}
              activeOpacity={0.8}
            >
              <View style={styles.verificationContent}>
                <View style={styles.verificationIcon}>
                  <ShieldCheck color="#f59e0b" size={20} />
                </View>
                <View style={styles.verificationTextContainer}>
                  <Text style={[styles.verificationTitle, isDark && { color: '#fbbf24' }]}>Hesabını Doğrula</Text>
                  <Text style={[styles.verificationSubtitle, isDark && { color: '#d4a574' }]}>
                    Tüm avantajlardan yararlan
                  </Text>
                </View>
              </View>
            </TouchableOpacity>
          )}

          {/* Kullanıcı Bilgileri */}

          {/* Settings Menu Items */}
          <View style={styles.menuSection}>
            <View style={[styles.menuCard, isDark && { backgroundColor: '#1e293b' }]}>
              <MenuItem 
                label="Hesap Ayarları" 
                icon={<UserIcon color={isDark ? '#fff' : '#000'} size={22} />}
                onPress={() => setAccountSettingsVisible(true)}
              />
              <MenuItem
                label="Gizlilik ve Güvenlik"
                icon={<ShieldCheck color={isDark ? '#fff' : '#000'} size={22} />}
                onPress={() => setPrivacyModalVisible(true)}
                isLast
              />
            </View>
          </View>

          {/* Notification Toggle */}
          <View style={styles.menuSection}>
            <View style={[styles.menuCard, isDark && { backgroundColor: '#1e293b' }]}>
              <View style={styles.switchRow}>
                <View style={styles.switchIconContainer}>
                  <Bell color={isDark ? '#fff' : '#000'} size={22} />
                </View>
                <Text style={[styles.switchLabel, isDark && { color: '#f8fafc' }]}>Bildirimler</Text>
                <Switch
                  value={eventNotificationsEnabled}
                  onValueChange={setEventNotificationsEnabled}
                  thumbColor="#fff"
                  trackColor={{ false: '#d1d5db', true: '#10b981' }}
                  ios_backgroundColor="#d1d5db"
                />
              </View>
            </View>
          </View>

          {/* Dark Mode Toggle */}
          <View style={styles.menuSection}>
            <View style={[styles.menuCard, isDark && { backgroundColor: '#1e293b' }]}>
              <View style={styles.switchRow}>
                <View style={styles.switchIconContainer}>
                  <Moon color={isDark ? '#fff' : '#000'} size={22} />
                </View>
                <Text style={[styles.switchLabel, isDark && { color: '#f8fafc' }]}>Karanlık Mod</Text>
                <Switch
                  value={isDark}
                  onValueChange={toggleTheme}
                  thumbColor="#fff"
                  trackColor={{ false: '#d1d5db', true: isDark ? '#3b82f6' : '#10b981' }}
                  ios_backgroundColor="#d1d5db"
                />
              </View>
            </View>
          </View>

          {/* Logout Button */}
          <View style={styles.menuSection}>
            <TouchableOpacity 
              style={styles.logoutButton}
              onPress={handleLogout}
              activeOpacity={0.8}
            >
              <Text style={styles.logoutText}>Çıkış Yap</Text>
            </TouchableOpacity>
          </View>

          {/* Verification Modal */}
          <Modal
            animationType="slide"
            transparent={true}
            visible={modalVisible}
            onRequestClose={() => setModalVisible(!modalVisible)}
          >
            <KeyboardAvoidingView 
              behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
              style={styles.modalBackdrop}
            >
              <View style={[styles.modalView, isDark && { backgroundColor: '#1e293b' }]}>
                <TouchableOpacity style={styles.closeButton} onPress={() => setModalVisible(false)}>
                  <X color={isDark ? '#94a3b8' : '#9ca3af'} size={24} />
                </TouchableOpacity>
                <Text style={[styles.modalTitle, isDark && { color: '#f8fafc' }]}>Numara ile Doğrulama</Text>
                <Text style={[styles.modalSubtitle, isDark && { color: '#94a3b8' }]}>
                  Avantajlardan yararlanmak için telefon numaranızı doğrulamanız gerekmektedir.
                </Text>
                <TextInput
                  placeholder="Telefon Numaranız"
                  placeholderTextColor={isDark ? '#64748b' : '#9ca3af'}
                  style={[styles.modalInput, isDark && { backgroundColor: '#334155', color: '#f8fafc' }]}
                  keyboardType="phone-pad"
                  maxLength={10}
                  autoFocus={true}
                />
                <TouchableOpacity style={styles.modalButton} onPress={() => setModalVisible(false)}>
                  <Text style={styles.modalButtonText}>Doğrula ve Devam Et</Text>
                </TouchableOpacity>
              </View>
            </KeyboardAvoidingView>
          </Modal>

          {/* Privacy Modal */}
          <Modal
            animationType="slide"
            transparent={true}
            visible={privacyModalVisible}
            onRequestClose={() => setPrivacyModalVisible(!privacyModalVisible)}
          >
            <View style={styles.modalBackdrop}>
              <View style={[styles.modalView, isDark && { backgroundColor: '#1e293b' }]}>
                <TouchableOpacity style={styles.closeButton} onPress={() => setPrivacyModalVisible(false)}>
                  <X color={isDark ? '#94a3b8' : '#9ca3af'} size={24} />
                </TouchableOpacity>
                <Text style={[styles.modalTitle, isDark && { color: '#f8fafc' }]}>Gizlilik ve Güvenlik</Text>
                <Text style={[styles.modalSubtitle, isDark && { color: '#94a3b8' }]}>
                  Uygulamamız, kişisel verilerinizi güvenli bir şekilde saklar ve işler. Konum, kullanım ve tercih bilgilerinizi yalnızca hizmetleri iyileştirmek ve size daha uygun içerikler sunmak için kullanırız.{'\n\n'}
                  Verileriniz şifrelenmiş olarak saklanır ve üçüncü taraflarla paylaşılmaz. Kişisel bilgilerinize her zaman buradan erişebilir ve güncelleyebilirsiniz.
                </Text>
                <TouchableOpacity style={styles.modalButton} onPress={() => setPrivacyModalVisible(false)}>
                  <Text style={styles.modalButtonText}>Anladım</Text>
                </TouchableOpacity>
              </View>
            </View>
          </Modal>

          {/* Account Settings Modal */}
          <Modal
            animationType="slide"
            transparent={true}
            visible={accountSettingsVisible}
            onRequestClose={() => setAccountSettingsVisible(!accountSettingsVisible)}
          >
            <View style={styles.modalBackdrop}>
              <View style={[styles.modalView, isDark && { backgroundColor: '#1e293b' }]}>
                <TouchableOpacity style={styles.closeButton} onPress={() => setAccountSettingsVisible(false)}>
                  <X color={isDark ? '#94a3b8' : '#9ca3af'} size={24} />
                </TouchableOpacity>
                <Text style={[styles.modalTitle, isDark && { color: '#f8fafc' }]}>Hesap Ayarları</Text>
                
                <ScrollView showsVerticalScrollIndicator={false} style={styles.modalScrollView}>
                  <Text style={[styles.inputLabel, isDark && { color: '#94a3b8' }]}>Kullanıcı Adı</Text>
                  <TextInput
                    placeholder="Kullanıcı Adı"
                    placeholderTextColor={isDark ? '#64748b' : '#9ca3af'}
                    style={[styles.modalInput, isDark && { backgroundColor: '#334155', color: '#f8fafc' }]}
                    value={userName}
                    onChangeText={setUserName}
                    autoCapitalize="words"
                  />

                  <Text style={[styles.inputLabel, isDark && { color: '#94a3b8' }]}>E-posta</Text>
                  <TextInput
                    placeholder="ornek@email.com"
                    placeholderTextColor={isDark ? '#64748b' : '#9ca3af'}
                    style={[styles.modalInput, isDark && { backgroundColor: '#334155', color: '#f8fafc' }]}
                    value={userEmail}
                    onChangeText={setUserEmail}
                    keyboardType="email-address"
                    autoCapitalize="none"
                    autoCorrect={false}
                  />
                </ScrollView>

                <TouchableOpacity 
                  style={styles.modalButton} 
                  onPress={() => {
                    setAccountSettingsVisible(false);
                    // Burada Supabase'e kaydedilebilir
                  }}
                >
                  <Text style={styles.modalButtonText}>Kaydet</Text>
                </TouchableOpacity>
              </View>
            </View>
          </Modal>
        </ScrollView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  root: {
    flex: 1,
    backgroundColor: '#f8fafc',
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingBottom: 100,
  },
  headerContainer: {
    marginBottom: 20,
  },
  gradientHeader: {
    height: 140,
    paddingTop: Platform.OS === 'ios' ? 50 : 20,
    paddingHorizontal: 20,
  },
  backButton: {
    width: 40,
    height: 40,
    justifyContent: 'center',
    alignItems: 'flex-start',
  },
  avatarContainer: {
    alignItems: 'center',
    marginTop: -50,
  },
  avatarWrapper: {
    marginBottom: 16,
  },
  avatarGradientBorder: {
    width: 110,
    height: 110,
    borderRadius: 55,
    padding: 3,
    justifyContent: 'center',
    alignItems: 'center',
  },
  avatarInner: {
    width: 104,
    height: 104,
    borderRadius: 52,
    backgroundColor: '#f3f4f6',
    justifyContent: 'center',
    alignItems: 'center',
  },
  avatarText: {
    color: '#8b5cf6',
    fontSize: 36,
    fontWeight: 'bold',
  },
  userName: {
    fontSize: 22,
    fontWeight: 'bold',
    color: Colors.darkGray,
    marginBottom: 6,
  },
  userStatus: {
    fontSize: 15,
    color: '#6b7280',
  },
  verificationCard: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fffbeb',
    borderRadius: 16,
    padding: 16,
    marginHorizontal: 20,
    marginTop: 20,
    borderWidth: 1,
    borderColor: '#fef3c7',
  },
  verificationContent: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
    gap: 12,
  },
  verificationIcon: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: '#fef3c7',
    justifyContent: 'center',
    alignItems: 'center',
  },
  verificationTextContainer: {
    flex: 1,
  },
  verificationTitle: {
    fontSize: 15,
    fontWeight: '600',
    color: '#92400e',
    marginBottom: 2,
  },
  verificationSubtitle: {
    fontSize: 13,
    color: '#b45309',
  },
  menuSection: {
    paddingHorizontal: 20,
    marginTop: 16,
  },
  menuCard: {
    backgroundColor: Colors.white,
    borderRadius: 12,
    overflow: 'hidden',
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 1 },
        shadowOpacity: 0.08,
        shadowRadius: 4,
      },
      android: {
        elevation: 2,
      },
    }),
  },
  infoRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 14,
    borderBottomWidth: 1,
    borderBottomColor: '#f3f4f6',
  },
  infoRowLast: {
    borderBottomWidth: 0,
  },
  infoLabel: {
    fontSize: 15,
    color: '#6b7280',
  },
  infoValue: {
    fontSize: 15,
    fontWeight: '600',
    color: Colors.darkGray,
  },
  menuItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#f3f4f6',
  },
  menuItemLast: {
    borderBottomWidth: 0,
  },
  menuItemLeft: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
    flex: 1,
  },
  menuIconContainer: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
  },
  menuItemText: {
    fontSize: 16,
    color: Colors.darkGray,
    fontWeight: '500',
  },
  switchRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 16,
  },
  switchIconContainer: {
    width: 40,
    height: 40,
    borderRadius: 20,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: 12,
  },
  switchLabel: {
    fontSize: 16,
    fontWeight: '500',
    color: Colors.darkGray,
    flex: 1,
  },
  logoutButton: {
    backgroundColor: '#ef4444',
    borderRadius: 12,
    paddingVertical: 16,
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 8,
  },
  logoutText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#fff',
  },
  modalBackdrop: {
    flex: 1,
    justifyContent: 'flex-end',
    backgroundColor: 'rgba(0,0,0,0.6)',
  },
  modalView: {
    backgroundColor: Colors.white,
    borderTopLeftRadius: 24,
    borderTopRightRadius: 24,
    padding: 24,
    paddingTop: 16,
    maxHeight: '90%',
  },
  closeButton: {
    alignSelf: 'flex-end',
    padding: 4,
    marginBottom: 8,
  },
  modalTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    marginBottom: 8,
    textAlign: 'center',
    color: Colors.darkGray,
  },
  modalSubtitle: {
    fontSize: 14,
    textAlign: 'center',
    color: '#6b7280',
    marginBottom: 24,
    lineHeight: 20,
  },
  modalScrollView: {
    maxHeight: 400,
    marginBottom: 16,
  },
  inputLabel: {
    fontSize: 14,
    fontWeight: '600',
    color: '#6b7280',
    marginBottom: 8,
    marginTop: 16,
  },
  modalInput: {
    width: '100%',
    height: 52,
    backgroundColor: '#f3f4f6',
    borderRadius: 12,
    marginBottom: 16,
    paddingHorizontal: 16,
    fontSize: 16,
  },
  modalButton: {
    width: '100%',
    height: 52,
    borderRadius: 12,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: Colors.primary.indigo,
  },
  modalButtonText: {
    color: Colors.white,
    fontSize: 16,
    fontWeight: '600',
  },
});

export default ProfileScreen;
